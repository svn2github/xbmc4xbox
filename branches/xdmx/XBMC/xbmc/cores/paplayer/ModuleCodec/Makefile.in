ARCH=@ARCH@
CFLAGS +=-D_LINUX -fPIC -Idumb/include
CXXFLAGS +=-D_LINUX -fPIC -Idumb/include
DIRS=dumb
OBJS=DumbDLL.o
SYSDIR=../../../../system/players/paplayer
SO=dumb-$(ARCH).so
SLIB=$(SYSDIR)/$(SO)

.PHONY: compile

$(SLIB): $(OBJS) dumb/lib/unix/libdumb.a
ifeq ($(findstring osx,$(ARCH)), osx)
	ld -bundle -flat_namespace -undefined suppress -o $@ \
		$(OBJS) dumb/lib/unix/libdumb.a $(BUNDLE1_O)
	../../../../tools/Mach5/wrapper.rb $@;mv output.so $@
	chmod +x $@

else
	$(CXX) -fPIC -shared -o $@ $(OBJS) -Wl,--whole-archive dumb/lib/unix/libdumb.a \
		-Wl,--no-whole-archive `cat ../../DllLoader/exports/wrapper.def` \
		../../DllLoader/exports/wrapper.o

endif

dumb/lib/unix/libdumb.a: compile
	$(MAKE) -C dumb

include ../../../../Makefile.include
