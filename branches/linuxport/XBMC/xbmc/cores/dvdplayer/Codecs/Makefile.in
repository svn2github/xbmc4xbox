
CC=@CC@
CXX=@CXX@
SHELL=/bin/bash
LDFLAGS=-shared -fPIC -rdynamic
ARCH=@ARCH@
SYSDIR=../../../../system/players/dvdplayer
WRAPPER=../../DllLoader/exports/wrapper.o
DIRS=ffmpeg libDVDCSS libdts libdvdnav libfaad2 libmad #liba52 libmpeg2
LIBS= avutil-51-$(ARCH).so \
			avcodec-51-$(ARCH).so \
			avformat-51-$(ARCH).so \
			postproc-51-$(ARCH).so \
			swscale-51-$(ARCH).so \
			libDVDCSS-$(ARCH).so \
			libdts-$(ARCH).so \
			libdvdnav-$(ARCH).so \
			libfaad-$(ARCH).so \
			libmad-$(ARCH).so
#			liba52-$(ARCH).so \
			libmpeg2-$(ARCH).so \

.PHONY: $(DIRS:ffmpeg=ffmpeg/*)

codecs: $(WRAPPER) $(LIBS)
	cp $(LIBS) $(SYSDIR)

avutil-51-$(ARCH).so: ffmpeg/libavutil
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libavutil/*.o

avcodec-51-$(ARCH).so: ffmpeg/libavcodec
	$(CC) -o $@ $(LDFLAGS) --soname,$@ /usr/lib/libfaac.a ffmpeg/libavcodec/*.o \
		ffmpeg/libavcodec/i386/*.o `cat $(WRAPPER:.o=.def)` $(WRAPPER)

avformat-51-$(ARCH).so: ffmpeg/libavformat
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libavformat/*.o \
		`cat $(WRAPPER:.o=.def)` $(WRAPPER)

swscale-51-$(ARCH).so: ffmpeg/libswscale
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libswscale/*.o \
		`cat $(WRAPPER:.o=.def)` $(WRAPPER)

postproc-51-$(ARCH).so: ffmpeg/libpostproc
	$(CC) -o $@ $(LDFLAGS) --soname,$@ ffmpeg/libpostproc/*.o \
		`cat $(WRAPPER:.o=.def)` $(WRAPPER)

libdts-$(ARCH).so: libdts
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libdts/libdts/bitstream.o \
		libdts/libdts/downmix.o libdts/libdts/parse.o -Wl`sed 's/[(\*]/ /g' \
		$(WRAPPER:.o=.c) | grep -v bash | awk \
		'/__wrap/ {out=out","$$2} END {print out}' | sed 's/__wrap_/-wrap,/g'` 

libDVDCSS-$(ARCH).so: libDVDCSS
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libDVDCSS/src/*.o -Wl`sed 's/[(\*]/ /g' $(WRAPPER:.o=.c) | grep -v bash | awk '/__wrap/ {out=out","$$2} END {print out}' | sed 's/__wrap_/-wrap,/g'`

libdvdnav-$(ARCH).so: libDVDCSS libdvdnav
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libDVDCSS/src/*.o libdvdnav/src/*.o libdvdnav/src/vm/*.o -Wl`sed 's/[(\*]/ /g' $(WRAPPER:.o=.c) | grep -v bash | awk '/__wrap/ {out=out","$$2} END {print out}' | sed 's/__wrap_/-wrap,/g'`

libfaad-$(ARCH).so: libfaad2
	$(CC) -o $@ $(LDFLAGS) --soname,$@ libfaad2/libfaad/*.o \
		`cat $(WRAPPER:.o=.def)`

libmad-$(ARCH).so: libmad
	cp libmad/.libs/libmad.so libmad-$(ARCH).so

ffmpeg/libavutil:
	$(MAKE) -C $@

ffmpeg/libavcodec: ffmpeg/libavutil
	$(MAKE) -C $@

ffmpeg/libavformat: ffmpeg/libavcodec
	$(MAKE) -C $@

ffmpeg/libpostproc: ffmpeg/libavutil
	$(MAKE) -C $@

ffmpeg/libswscale: ffmpeg/libavutil
	$(MAKE) -C $@

libdts:
	$(MAKE) -C $@

libDVDCSS:
	$(MAKE) -C $@

libdvdnav:
	$(MAKE) -C $@

libfaad2:
	$(MAKE) -C $@

libmad:
	$(MAKE) -C $@

clean:
	rm -f *.so
	for i in $(DIRS); do $(MAKE) -C "$$i" clean; done

distclean:
	rm -f *.so
	for i in $(DIRS); do $(MAKE) -C "$$i" distclean; done

