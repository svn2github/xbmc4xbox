BIN_DIRS=	\
	guilib \
	guilib/common \
	guilib/tinyXML \
	xbmc \
	xbmc/cdrip \
	xbmc/cores \
	xbmc/cores/DllLoader \
	xbmc/cores/DllLoader/exports \
	xbmc/cores/DllLoader/exports/util \
	xbmc/cores/dvdplayer \
	xbmc/cores/paplayer \
	xbmc/cores/AudioRenderers \
	xbmc/cores/VideoRenderers \
	xbmc/cores/VideoRenderers/VideoShaders \
	xbmc/cores/ExternalPlayer \
	xbmc/FileSystem \
	xbmc/FileSystem/MusicDatabaseDirectory \
	xbmc/FileSystem/VideoDatabaseDirectory \
	xbmc/lib/libcmyth \
	xbmc/lib/libGoAhead \
	xbmc/lib/libPython \
	xbmc/lib/libPython/xbmcmodule \
	xbmc/lib/libRTMP \
	xbmc/lib/libRTV \
	xbmc/lib/libscrobbler \
	xbmc/lib/libshout \
	xbmc/lib/libUPnP \
	xbmc/lib/libXBMS \
	xbmc/lib/libXDAAP \
	xbmc/lib/libcdio/libcdio \
	xbmc/lib/sqLite \
	xbmc/lib/UnrarXLib \
	xbmc/visualizations \
	xbmc/screensavers \
	xbmc/utils \
	xbmc/linux \
	xbmc/xbox \
	xbmc/osx

EC_DIRS= \
	tools/EventClients

XBMCTEX_DIRS= \
	tools/XBMCTex

DVDPCODECS_DIRS= \
	xbmc/cores/dvdplayer/Codecs \
	xbmc/lib/libass/xbmc \

PAPCODECS_DIRS= \
	xbmc/cores/paplayer/AC3Codec \
	xbmc/cores/paplayer/ADPCMCodec \
	xbmc/cores/paplayer/AACCodec \
	xbmc/cores/paplayer/NSFCodec \
	xbmc/cores/paplayer/timidity \
	xbmc/cores/paplayer/SIDCodec \
	xbmc/cores/paplayer/WavPackCodec \
	xbmc/cores/paplayer/GYMCodec \
	xbmc/cores/paplayer/YMCodec/StSoundLibrary \
	xbmc/cores/paplayer/ModuleCodec/vc6/dumb \
	xbmc/cores/paplayer/MPCCodec/xbmc \
	xbmc/cores/paplayer/SPCCodec/SNES/SNESAPU \
	xbmc/cores/paplayer/vgmstream \
	xbmc/cores/paplayer/MP3Codec \
	xbmc/cores/paplayer/flac-1.2.1/ \
	xbmc/cores/paplayer/MACDll \
	xbmc/cores/paplayer/vorbisfile

LIB_DIRS=\
	xbmc/lib/cximage-6.0 \
	xbmc/lib/libexif \
	xbmc/lib/libhdhomerun \
	xbmc/lib/libid3tag \
	xbmc/lib/libPython/linux

SS_DIRS=\
	xbmc/screensavers/rsxs-0.9/xbmc

VIS_DIRS=\
	xbmc/visualizations/OpenGLSpectrum \
	xbmc/visualizations/WaveForm \
	xbmc/visualizations/XBMCProjectM \
	xbmc/visualizations/Goom

PM3_MEDIA=skin/Project\ Mayhem\ III/media
PM3HD_MEDIA=skin/PM3.HD/media

DIRS= $(BIN_DIRS) $(EC_DIRS) $(XBMCTEX_DIRS) $(DVDPCODECS_DIRS) $(PAPCODECS_DIRS) \
	$(LIB_DIRS) $(SS_DIRS) $(VIS_DIRS)

DEBUG_FLAGS=@DEBUG_FLAGS@
LIBS=@LIBS@
CFLAGS=@CFLAGS@
CXXFLAGS=@CXXFLAGS@
LDFLAGS=@LDFLAGS@
INCLUDES=@INCLUDES@

CLEAN_FILES=xbmc.bin xbmc-xrandr

all : xbmc.bin externals xbmc-xrandr $(PM3_MEDIA)/Textures.xpr $(PM3HD_MEDIA)/Textures.xpr

include Makefile.include

.PHONY : guilib xbmc filesystem musicdatabase videodatabase cores paplayer dllloader exports osx xbox linux visualization-interface visualizations screensaver-interface screensavers utils common tinyxml sqllite libscrobbler unrarxlib libpython libgoahead compile dvdplayer libupnp libcmyth eventclients librtmp papcodecs dvdpcodecs imagelib codecs externals cdrip externalplayer libkaraoke

$(PM3_MEDIA)/Textures.xpr: tools/XBMCTex/XBMCTex $(PM3_MEDIA)/*.png $(PM3_MEDIA)/*/*.png
	 tools/XBMCTex/XBMCTex -input \"$(PM3_MEDIA)\" -output \"$(PM3_MEDIA)/Textures.xpr\"

$(PM3HD_MEDIA)/Textures.xpr: tools/XBMCTex/XBMCTex $(PM3HD_MEDIA)/*.png $(PM3HD_MEDIA)/*/*.png
	 tools/XBMCTex/XBMCTex -input \"$(PM3HD_MEDIA)\" -output \"$(PM3HD_MEDIA)/Textures.xpr\"

guilib: 
	$(MAKE) -C guilib
xbmc: 
	$(MAKE) -C xbmc
externalplayer: 
	$(MAKE) -C xbmc/cores/ExternalPlayer
filesystem: 
	$(MAKE) -C xbmc/FileSystem
musicdatabase: 
	$(MAKE) -C xbmc/FileSystem/MusicDatabaseDirectory
videodatabase: 
	$(MAKE) -C xbmc/FileSystem/VideoDatabaseDirectory
cores: 
	$(MAKE) -C xbmc/cores
audiorenderers: 
	$(MAKE) -C xbmc/cores/AudioRenderers
paplayer: 
	$(MAKE) -C xbmc/cores/paplayer
dllloader: exports
	$(MAKE) -C xbmc/cores/DllLoader
exports:
	$(MAKE) -C xbmc/cores/DllLoader/exports
	$(MAKE) -C xbmc/cores/DllLoader/exports/util
osx: 
ifeq ($(ARCH), osx)
	$(MAKE) -C xbmc/osx
endif
xbox: 
	$(MAKE) -C xbmc/xbox
linux: 
	$(MAKE) -C xbmc/linux
visualization-interface: 
	$(MAKE) -C xbmc/visualizations
visualizations: exports
	$(MAKE) -C xbmc/visualizations/OpenGLSpectrum
	$(MAKE) -C xbmc/visualizations/WaveForm
	$(MAKE) -C xbmc/visualizations/XBMCProjectM
	$(MAKE) -C xbmc/visualizations/Goom
screensaver-interface: 
	$(MAKE) -C xbmc/screensavers
screensavers: exports
	$(MAKE) -C xbmc/screensavers/rsxs-0.9/xbmc
utils: 
	$(MAKE) -C xbmc/utils
common: 
	$(MAKE) -C guilib/common
tinyxml: 
	$(MAKE) -C guilib/tinyXML
sqllite: 
	$(MAKE) -C xbmc/lib/sqLite
libscrobbler: 
	$(MAKE) -C xbmc/lib/libscrobbler
unrarxlib: 
	$(MAKE) -C xbmc/lib/UnrarXLib
libpython: dllloader
	$(MAKE) -C xbmc/lib/libPython
	$(MAKE) -C xbmc/lib/libPython/xbmcmodule
python:
	$(MAKE) -C xbmc/lib/libPython/linux
libgoahead: 
	$(MAKE) -C xbmc/lib/libGoAhead
libupnp: 
	$(MAKE) -C xbmc/lib/libUPnP
dvdplayer:
	$(MAKE) -C xbmc/cores/dvdplayer
	$(MAKE) -C xbmc/cores/VideoRenderers 
	$(MAKE) -C xbmc/cores/VideoRenderers/VideoShaders 
dvdpcodecs: dllloader
	$(MAKE) -C xbmc/cores/dvdplayer/Codecs
	$(MAKE) -C xbmc/lib/libass/xbmc
cdrip:
	$(MAKE) -C xbmc/cdrip
libcmyth: dllloader 
	$(MAKE) -C xbmc/lib/libcmyth
eventclients:
ifeq ($(ARCH), osx)
	$(MAKE) -C tools/EventClients/Clients/AppleRemote
else
	$(MAKE) -C tools/EventClients
endif
librtmp:
	$(MAKE) -C xbmc/lib/libRTMP
libxbms:
	$(MAKE) -C xbmc/lib/libXBMS
libexif: dllloader
	$(MAKE) -C xbmc/lib/libexif
librtv:
	$(MAKE) -C xbmc/lib/libRTV
libxdaap:
	$(MAKE) -C xbmc/lib/libXDAAP
libhdhomerun:
	$(MAKE) -C xbmc/lib/libhdhomerun
libshout:
	$(MAKE) -C xbmc/lib/libshout
libid3tag: dllloader
	$(MAKE) -C xbmc/lib/libid3tag
libcdio:
	$(MAKE) -C xbmc/lib/libcdio/libcdio
papcodecs: dllloader linux dvdpcodecs
	$(MAKE) -C xbmc/cores/paplayer/AACCodec
	$(MAKE) -C xbmc/cores/paplayer/AC3Codec
	$(MAKE) -C xbmc/cores/paplayer/ADPCMCodec
	$(MAKE) -C xbmc/cores/paplayer/flac-1.2.1
	$(MAKE) -C xbmc/cores/paplayer/GYMCodec
	$(MAKE) -C xbmc/cores/paplayer/MACDll
	$(MAKE) -C xbmc/cores/paplayer/vgmstream
ifneq ($(ARCH), x86_64-linux)
	$(MAKE) -C xbmc/cores/paplayer/ModuleCodec
	$(MAKE) -C xbmc/cores/paplayer/SPCCodec/SNES/SNESAPU
endif
	$(MAKE) -C xbmc/cores/paplayer/timidity
	$(MAKE) -C xbmc/cores/paplayer/MPCCodec/xbmc
	$(MAKE) -C xbmc/cores/paplayer/MP3Codec
	$(MAKE) -C xbmc/cores/paplayer/NSFCodec
	$(MAKE) -C xbmc/cores/paplayer/SIDCodec
	$(MAKE) -C xbmc/cores/paplayer/vorbisfile
	$(MAKE) -C xbmc/cores/paplayer/WavPackCodec
	$(MAKE) -C xbmc/cores/paplayer/YMCodec/StSoundLibrary	
imagelib: dllloader
	$(MAKE) -C xbmc/lib/cximage-6.0
libkaraoke:
	$(MAKE) -C xbmc/karaoke

codecs: papcodecs dvdpcodecs

libs: libhdhomerun libid3tag imagelib libexif python
	
externals: codecs libs python visualizations screensavers
more_libs: librtmp libxbms librtv libxdaap libshout libgoahead

compile: guilib xbmc filesystem musicdatabase videodatabase cores audiorenderers cdrip \
	paplayer dllloader exports osx xbox linux utils common tinyxml sqllite \
	libscrobbler libgoahead unrarxlib libpython dvdplayer libupnp libcmyth \
	librtmp libxbms librtv libxdaap libshout screensaver-interface \
	visualization-interface libcdio externalplayer libkaraoke

# platform independend objects
OBJSXBMC=	\
	guilib/*.o \
	guilib/common/*.o \
	guilib/tinyXML/*.o \
	xbmc/*.o \
	xbmc/cdrip/*.o \
	xbmc/cores/*.o \
	xbmc/cores/DllLoader/*.o \
	xbmc/cores/DllLoader/exports/*.o \
	xbmc/cores/DllLoader/exports/util/*.o \
	xbmc/cores/dvdplayer/DVDPlayer.a \
	xbmc/cores/paplayer/*.o \
	xbmc/cores/AudioRenderers/*.o \
	xbmc/cores/VideoRenderers/*.o \
	xbmc/cores/VideoRenderers/VideoShaders/*.o \
	xbmc/cores/ExternalPlayer/*.o \
	xbmc/FileSystem/*.o \
	xbmc/FileSystem/MusicDatabaseDirectory/*.o \
	xbmc/FileSystem/VideoDatabaseDirectory/*.o \
	xbmc/karaoke/*.o \
	xbmc/lib/libcdio/libcdio/lib/cdio++/*.o \
	xbmc/lib/libcdio/libcdio/lib/cdda_interface/*.o \
	xbmc/lib/libcdio/libcdio/lib/driver/*.o \
	xbmc/lib/libcdio/libcdio/lib/iso9660/*.o \
	xbmc/lib/libcdio/libcdio/lib/paranoia/*.o \
	xbmc/lib/libcdio/libcdio/lib/udf/*.o \
	xbmc/lib/libcmyth/*.o \
	xbmc/lib/libPython/*.o \
	xbmc/lib/libPython/xbmcmodule/*.o \
	xbmc/lib/libRTMP/*.o \
	xbmc/lib/libscrobbler/*.o \
	xbmc/lib/libRTV/librtv-@ARCH@.a \
	xbmc/lib/libshout/libshout-@ARCH@.a \
	xbmc/lib/libUPnP/libupnp-@ARCH@.a \
	xbmc/lib/libXBMS/libxbms-@ARCH@.a \
	xbmc/lib/libXDAAP/libxdaap-@ARCH@.a \
	xbmc/lib/libGoAhead/libGoAhead-@ARCH@.a \
	xbmc/lib/sqLite/*.o \
	xbmc/lib/UnrarXLib/*.o \
	xbmc/linux/*.o \
	xbmc/screensavers/*.o \
	xbmc/settings/*.o \
	xbmc/utils/*.o \
	xbmc/visualizations/*.o \
	xbmc/xbox/*.o

# platform dependend objects
ifeq ($(ARCH), osx)
OBJSXBMC += \
	xbmc/osx/*.o \
	xbmc/lib/libSDL-OSX/libSDL-osx.a \
	xbmc/lib/libSDL-OSX/libSDLmain-osx.a \
	xbmc/lib/libSDL-OSX/libSDL_image-osx.a \
	xbmc/lib/libSDL-OSX/libSDL_mixer-osx.a \
	system/players/dvdplayer/avutil-49-osx.a \
	system/players/dvdplayer/avcodec-52-osx.a \
	system/players/dvdplayer/swscale-0.6.1-osx.a \
	system/players/dvdplayer/avformat-52-osx.a \
	system/players/dvdplayer/postproc-51-osx.a

else
OBJSXBMC += \
	xbmc/lib/libsmb/libsmbclient-@ARCH@.a

endif

# TODO: XBPythonDLLFuncs.S not implemented on PowerPC
ifeq ($(ARCH), powerpc64-linux)
	# For some reason the XBMC version of libpython gets linker errors - use system version instead
	#OBJSXBMC += xbmc/lib/libPython/Python/libpython2.4.a
	LIBS += -lpython2.4
endif

$(wildcard $(OBJSXBMC)) :| compile

xbmc.bin: $(wildcard $(OBJSXBMC)) | compile
	$(CXX) $(DEBUG_FLAGS) -o xbmc.bin $(OBJSXBMC) $(LIBS) $(LDFLAGS) -rdynamic

xbmc-xrandr: xbmc-xrandr.c
ifeq ($(ARCH), osx)
	# xbmc-xrandr.c gets picked up by the default make rules
	#  so only exclude it for osx builds
	@echo "excluding xbmc-xrandr"
else
	gcc -g -o xbmc-xrandr xbmc-xrandr.c -lXrandr -lXrender -lX11 
endif

tools/XBMCTex/XBMCTex:
ifeq ($(ARCH), osx)
	# hack this for now
	$(MAKE) -C tools/XBMCTex -f Makefile.osx
else
	$(MAKE) -C tools/XBMCTex/
endif

install-bin: xbmc.bin # developement convenience target
	sudo cp -f xbmc.bin $(prefix)/share/xbmc

ifeq ($(ARCH), osx)
	# TODO: add osx install
else
install: install-datas install-web
	@echo "Copying XBMC binary to $(prefix)/share/xbmc/xbmc.bin"
	@cp -f xbmc.bin $(prefix)/share/xbmc/xbmc.bin
	@mkdir -p $(prefix)/bin
	@cp tools/Linux/xbmc.sh $(prefix)/bin/xbmc
	@chmod 755 $(prefix)/bin/xbmc
	@echo "Copying support and legal files,,,"
	@cp README.linux LICENSE.GPL *.txt xbmc-xrandr $(prefix)/share/xbmc/
	@echo "Done!"
	@echo "You can run XBMC with the command 'xbmc'"
endif

install-datas:
	@echo "Creating target directories in $(prefix)/share/xbmc"
	@find language media screensavers scripts skin sounds userdata visualisations system -type d -not -iregex ".*svn.*" -exec mkdir -p $(prefix)/share/xbmc/"{}" \; -printf " -- %f                           \r"
	@echo "Copying system files to $(prefix)/share/xbmc"
	@# Arch independent files
	@find language media screensavers scripts sounds userdata visualisations system -regextype posix-extended -type f -not -iregex ".*svn.*|.*\.so|.*\.dll|.*win32\.vis|.*osx\.vis" -exec cp "{}" $(prefix)/share/xbmc/"{}" \; -printf " -- %f                           \r"
	@# Arch dependent files
	@find system -regextype posix-extended -type f -not -iregex ".*svn.*" -iregex ".*@ARCH@.*" -exec cp "{}" $(prefix)/share/xbmc/"{}" \; -printf " -- %f                           \r"
	@# Skins
	@find skin -regextype posix-extended -type f -not -iregex ".*svn.*|.*\.png|.*\.gif" -exec cp '{}' $(prefix)/share/xbmc/'{}' \; -printf " -- %f                            \r"

install-web:
	@mkdir -p $(prefix)/share/xbmc/web
	@unzip -oq web/Project_Mayhem_III_webserver_v1.0.zip \
		-d $(prefix)/share/xbmc/web

uninstall:
	@echo "Removing XBMC..."
	@rm -rf $(prefix)/share/xbmc $(prefix)/bin/xbmc
	@echo "Done!"

reallyclean:
	@echo " This will delete ALL unversioned files in"; \
	 echo " your XBMC source tree. If you aren't sure"; \
	 echo " you want to do this, answer anything but"; \
	 echo " 'Y' (case sensitive) to the following."; \
	 echo " DISCLAIMER: Team XBMC is NOT responsible"; \
	 echo " for ANYTHING lost if you execute this command!"; \
	 echo -n " Damnserious? (Y/*) "; \
	 read -n1 PROMPT; \
	 if [[ "$$PROMPT" = "Y" ]]; then \
		SVNV=$$(svnversion -n | cut -d':' -f1); _IFS=$$IFS; IFS=$$'\t\n'; \
		for i in `svn st --no-ignore | grep ^[I\?] | cut -d' ' -f7-`; \
			do echo "  Deleting $$i"; \
			rm -rf "$$i"; \
		done; \
		IFS=$$_IFS; \
		echo " Recovering any missing files."; \
		svn up -r $${SVNV/M/} | cut -d' ' -f7- | awk '{print "  "$$0}'; \
		echo " Done."; \
		echo " The following files may need reverted (svn revert <file>)"; \
		svn st | grep ^M | cut -d' ' -f7- | awk '{print "  "$$0}'; \
	 else \
	 	echo; \
	 fi

clean-xbmc.bin:
	rm -f xbmc.bin
	for d in $(BIN_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-eventclients:
	for d in $(EC_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-xbmctex:
	for d in $(XBMCTEX_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-dvdpcodecs: 
	for d in $(DVDPCODECS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-papcodecs:
	for d in $(PAPCODECS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-libs: 
	for d in $(LIB_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-screensavers: 
	for d in $(SS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done
clean-visualisations:
	for d in $(VIS_DIRS); do if test -f $$d/Makefile; then $(MAKE) -C $$d clean; fi; done

clean-codecs: clean-dvdpcodecs clean-papcodecs

clean-externals: clean-codecs clean-eventclients clean-xbmctex clean-libs \
	clean-screensavers clean-visualisations

