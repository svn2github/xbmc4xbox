From abf62ced1700fda797e839bc8be5dfb43bd2e67a Mon Sep 17 00:00:00 2001
From: Cory Fields <theuni-nospam-@xbmc.org>
Date: Mon, 28 Jun 2010 01:34:29 -0400
Subject: [PATCH 03/36] asf hacks

---
 libavformat/asfdec.c |   15 ++++++++++++++-
 1 files changed, 14 insertions(+), 1 deletions(-)

Index: ffmpeg/libavformat/asfdec.c
===================================================================
--- ffmpeg.orig/libavformat/asfdec.c	2011-08-04 20:40:17.354521900 +0100
+++ ffmpeg/libavformat/asfdec.c	2011-08-04 20:51:38.122492600 +0100
@@ -1205,6 +1205,7 @@
         int64_t gsize= avio_rl64(s->pb);
         if (gsize < 24 || url_feof(s->pb)) {
             avio_seek(s->pb, current_pos, SEEK_SET);
+            asf->index_read= -1;
             return;
         }
         avio_skip(s->pb, gsize-24);
@@ -1245,9 +1246,20 @@
     int64_t pos;
     int index;
 
+    if (pts == 0) {
+      // this is a hack since av_gen_search searches the entire file in this case
+      av_log(s, AV_LOG_DEBUG, "SEEKTO: %"PRId64"\n", s->data_offset);
+      if (avio_seek(s->pb, s->data_offset, SEEK_SET) < 0)
+          return -1;
+      return 0;
+    }
+
     if (s->packet_size <= 0)
         return -1;
 
+    if (st->codec->codec_type != AVMEDIA_TYPE_VIDEO)
+        return -1;
+
     /* Try using the protocol's read_seek if available */
     if(s->pb) {
         int ret = avio_seek_time(s->pb, stream_index, pts, flags);
@@ -1268,7 +1280,8 @@
 
             /* do the seek */
             av_log(s, AV_LOG_DEBUG, "SEEKTO: %"PRId64"\n", pos);
-            avio_seek(s->pb, pos, SEEK_SET);
+            if(avio_seek(s->pb, pos, SEEK_SET)<0)
+               return -1;
             asf_reset_header(s);
             return 0;
         }
