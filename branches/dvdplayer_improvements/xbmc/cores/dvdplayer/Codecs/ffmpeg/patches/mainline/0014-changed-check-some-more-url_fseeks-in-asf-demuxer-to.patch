From 9f19ad85257c413cf6c1facb6dc49efa8a10b6b3 Mon Sep 17 00:00:00 2001
From: Cory Fields <theuni-nospam-@xbmc.org>
Date: Mon, 28 Jun 2010 22:27:09 -0400
Subject: [PATCH 14/36] changed: check some more avio_seeks in asf demuxer to avoid problems if file system is unseekable

---
 libavformat/asfdec.c |    9 +++++++--
 1 files changed, 7 insertions(+), 2 deletions(-)

Index: ffmpeg/libavformat/asfdec.c
===================================================================
--- ffmpeg.orig/libavformat/asfdec.c	2011-08-04 20:51:38.122492600 +0100
+++ ffmpeg/libavformat/asfdec.c	2011-08-04 20:51:44.061031800 +0100
@@ -1154,7 +1154,8 @@
     if (s->packet_size > 0)
         pos= (pos+s->packet_size-1-s->data_offset)/s->packet_size*s->packet_size+ s->data_offset;
     *ppos= pos;
-    avio_seek(s->pb, pos, SEEK_SET);
+    if (avio_seek(s->pb, pos, SEEK_SET) < 0)
+        return AV_NOPTS_VALUE;
 
 //printf("asf_read_pts\n");
     asf_reset_header(s);
@@ -1196,7 +1197,11 @@
     int64_t current_pos= avio_tell(s->pb);
     int i;
 
-    avio_seek(s->pb, asf->data_object_offset + asf->data_object_size, SEEK_SET);
+    if(avio_seek(s->pb, asf->data_object_offset + asf->data_object_size, SEEK_SET) < 0) {
+      asf->index_read= -1;
+      return;
+    }
+
     ff_get_guid(s->pb, &g);
 
     /* the data object can be followed by other top-level objects,
