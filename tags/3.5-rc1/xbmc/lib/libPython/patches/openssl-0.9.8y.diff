diff -ru ../t/openssl-0.9.8y/crypto/aes/aes_locl.h ./crypto/aes/aes_locl.h
--- a/crypto/aes/aes_locl.h	2013-02-04 23:40:11.000000000 +0000
+++ b/crypto/aes/aes_locl.h	2014-07-12 19:37:24.801640300 +0100
@@ -62,7 +62,7 @@
 #include <stdlib.h>
 #include <string.h>
 
-#if defined(_MSC_VER) && (defined(_M_IX86) || defined(_M_AMD64) || defined(_M_X64))
+#if defined(_MSC_VER) && !defined(_XBOX) && (defined(_M_IX86) || defined(_M_AMD64) || defined(_M_X64))
 # define SWAP(x) (_lrotl(x, 8) & 0x00ff00ff | _lrotr(x, 8) & 0xff00ff00)
 # define GETU32(p) SWAP(*((u32 *)(p)))
 # define PUTU32(ct, st) { *((u32 *)(ct)) = SWAP((st)); }
diff -ru ../t/openssl-0.9.8y/crypto/camellia/cmll_locl.h ./crypto/camellia/cmll_locl.h
--- a/crypto/camellia/cmll_locl.h	2013-02-05 11:58:59.000000000 +0000
+++ b/crypto/camellia/cmll_locl.h	2014-07-12 19:38:21.342942700 +0100
@@ -80,7 +80,7 @@
 extern "C" {
 #endif
 
-#if defined(_MSC_VER) && (defined(_M_IX86) || defined(_M_AMD64) || defined(_M_X64))
+#if defined(_MSC_VER) && && !defined(_XBOX) && (defined(_M_IX86) || defined(_M_AMD64) || defined(_M_X64))
 # define SWAP(x) ( _lrotl(x, 8) & 0x00ff00ff | _lrotr(x, 8) & 0xff00ff00 )
 # define GETU32(p) SWAP(*((u32 *)(p)))
 # define PUTU32(ct, st) { *((u32 *)(ct)) = SWAP((st)); }
diff -ru ../t/openssl-0.9.8y/crypto/cast/cast_lcl.h ./crypto/cast/cast_lcl.h
--- a/crypto/cast/cast_lcl.h	2013-02-04 23:40:11.000000000 +0000
+++ b/crypto/cast/cast_lcl.h	2014-07-12 19:38:43.454737900 +0100
@@ -152,7 +152,7 @@
                          *((c)++)=(unsigned char)(((l)>> 8L)&0xff), \
                          *((c)++)=(unsigned char)(((l)     )&0xff))
 
-#if defined(OPENSSL_SYS_WIN32) && defined(_MSC_VER)
+#if defined(OPENSSL_SYS_WIN32) && defined(_MSC_VER) && !defined(_XBOX)
 #define ROTL(a,n)     (_lrotl(a,n))
 #else
 #define ROTL(a,n)     ((((a)<<(n))&0xffffffffL)|((a)>>(32-(n))))
diff -ru ../t/openssl-0.9.8y/crypto/md32_common.h ./crypto/md32_common.h
--- a/crypto/md32_common.h	2013-02-05 11:58:59.000000000 +0000
+++ b/crypto/md32_common.h	2014-07-12 19:39:30.502389100 +0100
@@ -142,7 +142,7 @@
  */
 #undef ROTATE
 #ifndef PEDANTIC
-# if defined(_MSC_VER) || defined(__ICC)
+# if (defined(_MSC_VER) || defined(__ICC)) && !defined(_XBOX)
 #  define ROTATE(a,n)	_lrotl(a,n)
 # elif defined(__MWERKS__)
 #  if defined(__POWERPC__)
diff -ru ../t/openssl-0.9.8y/crypto/rand/rand_win.c ./crypto/rand/rand_win.c
--- a/crypto/rand/rand_win.c	2013-02-05 02:36:25.000000000 +0000
+++ b/crypto/rand/rand_win.c	2014-07-12 18:45:13.115683800 +0100
@@ -203,7 +203,14 @@
         osverinfo.dwOSVersionInfoSize = sizeof(OSVERSIONINFO) ;
         GetVersionEx( &osverinfo ) ;
 
-#if defined(OPENSSL_SYS_WINCE)
+#if defined(_XBOX)
+	{
+	BYTE buf[64];
+	// not a real API function, so hProvider is not used.
+	if (CryptGenRandom(hProvider, sizeof(buf), buf))
+		RAND_add(buf, sizeof(buf), sizeof(buf));
+	}
+#elif defined(OPENSSL_SYS_WINCE)
 # if defined(_WIN32_WCE) && _WIN32_WCE>=300
 /* Even though MSDN says _WIN32_WCE>=210, it doesn't seem to be available
  * in commonly available implementations prior 300... */
diff -ru ../t/openssl-0.9.8y/crypto/rc5/rc5_locl.h ./crypto/rc5/rc5_locl.h
--- a/crypto/rc5/rc5_locl.h	2013-02-05 11:58:59.000000000 +0000
+++ b/crypto/rc5/rc5_locl.h	2014-07-12 19:39:55.934938300 +0100
@@ -146,7 +146,7 @@
                          *((c)++)=(unsigned char)(((l)>> 8L)&0xff), \
                          *((c)++)=(unsigned char)(((l)     )&0xff))
 
-#if (defined(OPENSSL_SYS_WIN32) && defined(_MSC_VER)) || defined(__ICC)
+#if (defined(OPENSSL_SYS_WIN32) && defined(_MSC_VER) && !defined(_XBOX)) || defined(__ICC)
 #define ROTATE_l32(a,n)     _lrotl(a,n)
 #define ROTATE_r32(a,n)     _lrotr(a,n)
 #elif defined(__GNUC__) && __GNUC__>=2 && !defined(__STRICT_ANSI__) && !defined(OPENSSL_NO_ASM) && !defined(OPENSSL_NO_INLINE_ASM) && !defined(PEDANTIC)
diff -ru ../t/openssl-0.9.8y/util/pl/VC-32.pl ./util/pl/VC-32.pl
--- a/util/pl/VC-32.pl	2013-02-05 11:58:59.000000000 +0000
+++ b/util/pl/VC-32.pl	2014-07-12 18:45:13.123242000 +0100
@@ -116,7 +116,7 @@
     $base_cflags.=' -D_CRT_NONSTDC_NO_DEPRECATE';	# shut up VC8
     my $f = $shlib || $fips ?' /MD':' /MT';
     $lib_cflag='/Zl' if (!$shlib);	# remove /DEFAULTLIBs from static lib
-    $opt_cflags=$f.' /Ox /O2 /Ob2';
+    $opt_cflags=$f.' /O1 /Ob1';
     $dbg_cflags=$f.'d /Od -DDEBUG -D_DEBUG';
     $lflags="/nologo /subsystem:console /opt:ref";
     }
@@ -242,7 +242,7 @@
 	$rmd160_asm_src='crypto\ripemd\asm\rm_win32.asm';
 	$cpuid_asm_obj='crypto\cpu_win32.obj';
 	$cpuid_asm_src='crypto\cpu_win32.asm';
-	$cflags.=" -DOPENSSL_CPUID_OBJ -DOPENSSL_IA32_SSE2 -DAES_ASM -DBN_ASM -DOPENSSL_BN_ASM_PART_WORDS -DOPENSSL_BN_ASM_MONT -DMD5_ASM -DSHA1_ASM -DRMD160_ASM";
+	$cflags.=" -D_XBOX -DOPENSSL_CPUID_OBJ -DAES_ASM -DBN_ASM -DOPENSSL_BN_ASM_PART_WORDS -DOPENSSL_BN_ASM_MONT -DMD5_ASM -DSHA1_ASM -DRMD160_ASM";
 	}
     elsif ($FLAVOR =~ "WIN64A")
 	{
